<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swift Transport Booking</title>
    <style>
        /* All your existing styles remain untouched */
        /* ... (CSS as per your provided code) ... */
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsqYdVFXJcuUpxwkIEPJxEAGN2jlf-tT4&libraries=places"></script>
</head>
<body>
    <h1>Book Your Ride</h1>
    <form id="bookingForm">
        <!-- All your existing form elements remain untouched -->
        <!-- ... (HTML as per your provided code) ... -->

        <button type="submit" id="confirmInfoBtn" class="blinking">Confirm Info</button>

        <!-- Blinking Referral & Balance Section -->
        <div id="referralSection">
            <div class="referral-label">ID/Referral Code: <span id="referralCode">12345</span></div>
            <div class="referral-label">User's Tier: <span id="userTier">Gold</span> (5% discount)</div>
            <div class="referral-label">Referral Count: <span id="referralCount">5</span></div>
            <div class="referral-label">Referral Earnings: <span id="referralEarnings">$25</span></div>
            <div class="referral-label">Rides Earnings: <span id="rideEarnings">$15</span></div>
            <div class="referral-label">Total Balance: <span id="totalBalance">$40</span></div>
            <button class="referral-button" id="applyBalanceBtn">Apply Balance</button>
            <button class="referral-button" id="applyTierDiscountBtn">Apply Tier Discount</button>
        </div>

        <!-- Fare container and other elements remain untouched -->
        <!-- ... (HTML as per your provided code) ... -->
    </form>

    <div class="eta" id="etaDisplay"></div>
    <div id="map"></div>

    <div id="shareSection">
        <h2>Enjoy our great prices? Please tell a friend about us. Thanks for your support!</h2>
        <button id="shareSMSBtn">Share via SMS</button>
        <button id="shareFacebookBtn">Share via Facebook</button>
        <button id="shareInstagramBtn">Share via Instagram</button>
    </div>

    <script>
        // Google Sheets URL and API Setup
        const googleSheetUrl = 'https://script.google.com/macros/s/AKfycbx9IfeKQ_LAPI_KEY_HERE/exec'; // Replace with your actual Google Apps Script URL

        // Fetch user data from Google Sheets
        function fetchUserData(userId) {
            return fetch(`${googleSheetUrl}?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        return data.userData;
                    } else {
                        throw new Error('User not found in Google Sheets');
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    return null;
                });
        }

        document.getElementById('confirmInfoBtn').addEventListener('click', function (event) {
            event.preventDefault();

            // Validate pickup time and other logic
            if (!validatePickupTime()) return;

            const userId = document.getElementById('referralCode').innerText; // Assuming referralCode is the user's ID

            // Fetch data from Google Sheets and update fields
            fetchUserData(userId).then(userData => {
                if (userData) {
                    // Update the form with the fetched data
                    document.getElementById('userTier').innerText = userData.tier;
                    document.getElementById('referralCount').innerText = userData.referralCount;
                    document.getElementById('referralEarnings').innerText = `$${userData.referralEarnings}`;
                    document.getElementById('rideEarnings').innerText = `$${userData.ridesEarnings}`;
                    document.getElementById('totalBalance').innerText = `$${userData.balance}`;

                    // Call existing logic to show fare and other elements after updating from Google Sheets
                    // ... (existing logic here) ...
                } else {
                    alert('User data not found in the database. Please try again.');
                }
            });

            // Continue with your existing map and fare calculation code
            // Google Maps and fare calculation logic
            const pickup = document.getElementById('pickupLocation').value;
            const dropoff = document.getElementById('dropoffLocation').value;

            const directionsService = new google.maps.DirectionsService();
            const departureTime = new Date(`${document.getElementById('pickupDate').value}T${document.getElementById('pickupTime').value}`);
            directionsService.route({
                origin: pickupCoords,
                destination: dropoffCoords,
                travelMode: google.maps.TravelMode.DRIVING,
                drivingOptions: {
                    departureTime: departureTime,
                }
            }, function (response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    const distance = response.routes[0].legs[0].distance.value / 1609.34; // Convert meters to miles
                    const travelTime = response.routes[0].legs[0].duration_in_traffic.value / 60; // Convert seconds to minutes

                    // Your existing fare calculation and breakdown logic
                    let fare = baseFare;
                    // ...

                    // Update and display fare breakdown
                    document.getElementById('fareContainer').style.display = 'block';
                    document.getElementById('tipOptions').style.visibility = 'visible';
                    document.getElementById('confirmRideBtn').disabled = false;
                    document.getElementById('cancelBtn').disabled = false;

                    document.getElementById('referralSection').style.display = 'block';
                    document.getElementById('confirmInfoBtn').classList.remove('blinking');
                    document.getElementById('confirmInfoBtn').disabled = true;
                    document.getElementById('confirmInfoBtn').style.backgroundColor = '#6c757d';
                } else {
                    alert('Could not calculate the route.');
                }
            });
        });

        // Continue with your existing JavaScript for tips, ride confirmation, social sharing, etc.
        // All other existing functionalities remain untouched

        // Initialize Google Map on page load
        window.onload = function () {
            initMap();
            showAlertMessage();
        };
    </script>
</body>
</html>
